<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qwen3-ASR 高级客户端</title>
    <style>
        :root {
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-200: #bfdbfe;
            --primary-300: #93c5fd;
            --primary-400: #60a5fa;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --primary-800: #1e40af;
            --primary-900: #1e3a8a;
            --neutral-50: #f8fafc;
            --neutral-100: #f1f5f9;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #475569;
            --neutral-700: #334155;
            --neutral-800: #1e293b;
            --neutral-900: #0f172a;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--neutral-100);
            color: var(--neutral-800);
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05), 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(90deg, var(--primary-600), var(--primary-700));
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.8rem;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--neutral-200);
            background: var(--neutral-50);
        }
        
        .tab-button {
            padding: 12px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--neutral-600);
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .tab-button.active {
            color: var(--primary-600);
            border-bottom-color: var(--primary-600);
            background: white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .column {
            flex: 1;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--neutral-700);
        }
        
        select, button {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--neutral-300);
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: var(--primary-600);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s ease;
        }
        
        button:hover {
            background: var(--primary-700);
        }
        
        button:disabled {
            background: var(--neutral-400);
            cursor: not-allowed;
        }
        
        .btn-row {
            display: flex;
            gap: 10px;
        }
        
        .btn-row button {
            flex: 1;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            padding: 12px;
            border: 1px solid var(--neutral-300);
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }
        
        .status-bar {
            padding: 10px 15px;
            background: var(--neutral-100);
            border-radius: 4px;
            margin-top: 15px;
            font-size: 14px;
            color: var(--neutral-600);
        }
        
        .audio-player {
            margin-top: 15px;
        }
        
        .audio-player audio {
            width: 100%;
        }
        
        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background-color: #ef4444;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        
        .visualizer {
            height: 60px;
            background: var(--neutral-50);
            border-radius: 4px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }
        
        .visualizer-bar {
            position: absolute;
            bottom: 0;
            width: 4px;
            background: var(--primary-500);
            border-radius: 2px 2px 0 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Qwen3-ASR 高级语音识别</h1>
            <p>支持上传音频文件或使用麦克风进行实时语音识别</p>
        </div>
        
        <div class="tabs">
            <button class="tab-button active" data-tab="upload">上传音频</button>
            <button class="tab-button" data-tab="microphone">麦克风录音</button>
        </div>
        
        <div class="tab-content active" id="upload-tab">
            <div class="row">
                <div class="column">
                    <div class="form-group">
                        <label for="audio-upload">上传音频文件</label>
                        <input type="file" id="audio-upload" accept="audio/*" style="display: none;">
                        <button type="button" onclick="document.getElementById('audio-upload').click()">选择音频文件</button>
                        <div id="file-name" style="margin-top: 5px; font-size: 12px; color: var(--neutral-500);"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="upload-language">指定语言（设为None则自动检测）</label>
                        <select id="upload-language">
                            <option value="auto">自动检测</option>
                            <option value="zh">中文</option>
                            <option value="en">英文</option>
                            <option value="yue">粤语</option>
                            <option value="ja">日语</option>
                            <option value="ko">韩语</option>
                            <option value="de">德语</option>
                            <option value="fr">法语</option>
                            <option value="es">西班牙语</option>
                        </select>
                    </div>
                    
                    <button id="upload-btn">转录音频</button>
                </div>
                
                <div class="column">
                    <label>转录结果</label>
                    <textarea id="upload-result" readonly placeholder="转录结果将显示在这里..."></textarea>
                    <div class="status-bar" id="upload-status">就绪</div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="microphone-tab">
            <div class="row">
                <div class="column">
                    <div class="form-group">
                        <label for="mic-device">选择麦克风设备</label>
                        <select id="mic-device">
                            <option value="">默认设备</option>
                        </select>
                        <div id="mic-device-hint" style="margin-top: 4px; font-size: 12px; color: var(--neutral-500); min-height: 16px;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="mic-language">指定语言（设为None则自动检测）</label>
                        <select id="mic-language">
                            <option value="auto">自动检测</option>
                            <option value="zh">中文</option>
                            <option value="en">英文</option>
                            <option value="yue">粤语</option>
                            <option value="ja">日语</option>
                            <option value="ko">韩语</option>
                            <option value="de">德语</option>
                            <option value="fr">法语</option>
                            <option value="es">西班牙语</option>
                        </select>
                    </div>
                    
                    <div class="btn-row">
                        <button id="start-rec-btn">开始录音</button>
                        <button id="stop-rec-btn" disabled>停止录音</button>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <div id="rec-status">就绪</div>
                        <div class="visualizer" id="audio-visualizer"></div>
                    </div>
                    
                    <div class="audio-player">
                        <button id="play-btn" disabled>播放录音</button>
                        <div class="audio-player" id="audio-player-container" style="display: none;">
                            <audio id="audio-player" controls></audio>
                        </div>
                    </div>
                </div>
                
                <div class="column">
                    <label>转录结果</label>
                    <textarea id="mic-result" readonly placeholder="转录结果将显示在这里..."></textarea>
                    <div class="status-bar" id="mic-status">就绪</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API 地址：若你的服务映射到其它端口，改这里（与 WSL Docker -p 一致）
        const API_BASE = 'http://localhost:8000';

        // 全局变量
        let mediaRecorder;
        let audioChunks = [];
        let recordedAudioBlob;
        let audioContext;
        let analyser;
        let animationId;

        // 检查是否在安全上下文中（HTTPS 或 localhost）。file:// 下无法可靠使用麦克风
        function isSecureContext() {
            return typeof window.isSecureContext !== 'undefined' && window.isSecureContext
                && navigator.mediaDevices && typeof navigator.mediaDevices.enumerateDevices === 'function';
        }

        // 获取真实设备列表（需要先有麦克风权限才能拿到完整标签，否则标签可能为空）
        async function populateDeviceList(requirePermission = false) {
            const selectElement = document.getElementById('mic-device');
            const hintEl = document.getElementById('mic-device-hint');

            if (!isSecureContext()) {
                selectElement.innerHTML = '<option value="">默认设备</option>';
                if (hintEl) hintEl.textContent = '请通过 localhost 或 HTTPS 打开本页面，否则无法使用麦克风';
                return;
            }

            try {
                if (requirePermission) {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                }

                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(d => d.kind === 'audioinput');
                selectElement.innerHTML = '<option value="">默认设备</option>';

                audioInputs.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `麦克风 ${index + 1}`;
                    selectElement.appendChild(option);
                });

                if (hintEl) hintEl.textContent = audioInputs.length ? '' : '未检测到麦克风设备';
            } catch (err) {
                console.error('无法获取设备列表:', err);
                selectElement.innerHTML = '<option value="">默认设备</option>';
                if (hintEl) hintEl.textContent = '需要允许麦克风权限才能列出设备，或使用默认设备';
            }
        }

        // 是否已在麦克风标签内请求过权限并拉取过设备列表
        let micTabDeviceListLoaded = false;

        // 初始化
        async function init() {
            // 先不请求麦克风权限，仅在有 mediaDevices 时预填一次（可能无标签）
            if (isSecureContext()) {
                await populateDeviceList(false);
                navigator.mediaDevices.addEventListener('devicechange', () => {
                    populateDeviceList(micTabDeviceListLoaded);
                });
            } else {
                populateDeviceList(false);
            }

            // 设置标签切换：切换到麦克风标签时再请求权限并刷新设备列表（才能显示设备名称）
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', async () => {
                    const tabId = button.getAttribute('data-tab');
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabId}-tab`).classList.add('active');

                    if (tabId === 'microphone' && isSecureContext() && !micTabDeviceListLoaded) {
                        micTabDeviceListLoaded = true;
                        await populateDeviceList(true);
                    }
                });
            });

            setupEventListeners();
        }

        function setupEventListeners() {
            // 上传标签
            document.getElementById('audio-upload').addEventListener('change', function(e) {
                const fileName = e.target.files[0]?.name || '';
                document.getElementById('file-name').textContent = fileName || '未选择文件';
            });
            
            document.getElementById('upload-btn').addEventListener('click', handleUpload);
            
            // 麦克风标签
            document.getElementById('start-rec-btn').addEventListener('click', startRecording);
            document.getElementById('stop-rec-btn').addEventListener('click', stopRecording);
            document.getElementById('play-btn').addEventListener('click', playRecording);
        }

        // 处理上传
        async function handleUpload() {
            const fileInput = document.getElementById('audio-upload');
            const language = document.getElementById('upload-language').value;
            const statusEl = document.getElementById('upload-status');
            
            if (!fileInput.files[0]) {
                alert('请选择音频文件');
                return;
            }
            
            statusEl.textContent = '正在上传和转录...';
            
            const formData = new FormData();
            formData.append('audio', fileInput.files[0], fileInput.files[0].name);
            formData.append('language', language);
            
            try {
                const response = await fetch(API_BASE + '/transcribe', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    document.getElementById('upload-result').value = result.text;
                    statusEl.textContent = `转录完成 (语言: ${result.language})`;
                } else {
                    throw new Error(result.error || '未知错误');
                }
            } catch (error) {
                console.error('转录失败:', error);
                let msg = error.message;
                if (msg === 'Failed to fetch') {
                    msg = '无法连接服务器。请确认：① WSL 里 API 已启动 ② Docker 端口映射正确（如 -p 8000:80）③ 本页 API 地址为 ' + API_BASE;
                }
                document.getElementById('upload-result').value = '转录失败: ' + msg;
                statusEl.textContent = '转录失败: ' + msg;
            }
        }

        // 开始录音
        async function startRecording() {
            try {
                // 确保audioContext已创建
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const deviceId = document.getElementById('mic-device').value;
                const constraints = {
                    audio: deviceId
                        ? { deviceId: { ideal: deviceId } }
                        : true
                };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // 设置音频可视化
                setupAudioVisualizer(stream);
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    if (event.data && event.data.size > 0) audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    // 使用 MediaRecorder 真实输出的格式（多为 audio/webm），不要标成 audio/wav 否则服务端会解析错误
                    const mime = mediaRecorder.mimeType || 'audio/webm';
                    const ext = mime.indexOf('webm') !== -1 ? 'webm' : (mime.indexOf('ogg') !== -1 ? 'ogg' : 'webm');
                    recordedAudioBlob = new Blob(audioChunks, { type: mime });

                    stream.getTracks().forEach(track => track.stop());
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                    }
                    document.getElementById('audio-visualizer').innerHTML = '';
                    document.getElementById('start-rec-btn').disabled = false;
                    document.getElementById('stop-rec-btn').disabled = true;
                    document.getElementById('rec-status').innerHTML = '就绪';
                    document.getElementById('play-btn').disabled = false;

                    if (recordedAudioBlob.size === 0) {
                        document.getElementById('mic-status').textContent = '录音为空，请录久一点再点停止';
                        return;
                    }
                    await transcribeRecordedAudio();
                };

                // 每 200ms 收一次数据，避免只依赖 stop 时的一次数据（更稳定）
                mediaRecorder.start(200);

                document.getElementById('start-rec-btn').disabled = true;
                document.getElementById('stop-rec-btn').disabled = false;
                document.getElementById('rec-status').innerHTML = '<span class="recording-indicator"></span>正在录音...';
            } catch (err) {
                console.error('无法访问麦克风:', err);
                document.getElementById('mic-status').textContent = '无法访问麦克风: ' + err.message;
                
                // 更新UI状态
                document.getElementById('start-rec-btn').disabled = false;
                document.getElementById('stop-rec-btn').disabled = true;
                document.getElementById('rec-status').textContent = '无法访问麦克风: ' + err.message;
            }
        }

        // 设置音频可视化
        function setupAudioVisualizer(stream) {
            // 确保audioContext已存在
            if (!audioContext) {
                console.error('AudioContext未初始化');
                return;
            }
            
            // 如果分析器已存在，先断开连接
            if (analyser) {
                analyser.disconnect();
            }
            
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            function draw() {
                if (!analyser) return; // 如果分析器被清除则退出
                
                animationId = requestAnimationFrame(draw);
                
                analyser.getByteFrequencyData(dataArray);
                
                const visualizer = document.getElementById('audio-visualizer');
                visualizer.innerHTML = '';
                
                const barWidth = (visualizer.offsetWidth / bufferLength) * 2.5;
                let barHeight;
                let x = 0;
                
                for (let i = 0; i < bufferLength; i++) {
                    barHeight = dataArray[i] / 2;
                    
                    const bar = document.createElement('div');
                    bar.className = 'visualizer-bar';
                    bar.style.height = barHeight + 'px';
                    bar.style.left = x + 'px';
                    
                    visualizer.appendChild(bar);
                    x += barWidth + 1;
                }
            }
            
            draw();
        }

        // 停止录音
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                document.getElementById('stop-rec-btn').disabled = true;
                document.getElementById('start-rec-btn').disabled = false;
            }
        }

        // 播放录音
        function playRecording() {
            if (recordedAudioBlob) {
                const audioUrl = URL.createObjectURL(recordedAudioBlob);
                const audioPlayer = document.getElementById('audio-player');
                const playerContainer = document.getElementById('audio-player-container');
                
                audioPlayer.src = audioUrl;
                playerContainer.style.display = 'block';
                
                audioPlayer.play().catch(err => {
                    console.error('播放失败:', err);
                });
            }
        }

        // 转录录音
        async function transcribeRecordedAudio() {
            const statusEl = document.getElementById('mic-status');
            if (!recordedAudioBlob || recordedAudioBlob.size === 0) {
                statusEl.textContent = '没有可上传的录音，请先录音再停止';
                return;
            }
            statusEl.textContent = '正在转录...';

            const mime = recordedAudioBlob.type || 'audio/webm';
            const ext = mime.indexOf('webm') !== -1 ? 'webm' : (mime.indexOf('ogg') !== -1 ? 'ogg' : 'webm');
            const formData = new FormData();
            formData.append('audio', recordedAudioBlob, 'recording.' + ext);
            formData.append('language', document.getElementById('mic-language').value);

            try {
                const response = await fetch(API_BASE + '/transcribe', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    document.getElementById('mic-result').value = result.text;
                    statusEl.textContent = `转录完成 (语言: ${result.language})`;
                } else {
                    throw new Error(result.error || '未知错误');
                }
            } catch (error) {
                console.error('转录失败:', error);
                let msg = error.message;
                if (msg === 'Failed to fetch') {
                    msg = '无法连接服务器。请确认：① WSL 里 API 已启动 ② Docker 端口映射正确（如 -p 8000:80）③ 本页 API 地址为 ' + API_BASE;
                }
                document.getElementById('mic-result').value = '转录失败: ' + msg;
                statusEl.textContent = '转录失败: ' + msg;
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
